pipeline{
    agent any
    environment {
      DOCKER_PROD_HOST="tcp://45.155.170.65:2375"
      DOCKER_PRIVATE_REGISTER="registry.dsp-archiwebo21-ct-df-an-cd.fr"
      REGISTRY_CRED=credentials('jenkins-registry-credential')
    }
      
    stages{

        stage("build") {
            parallel {
               stage("mongodb"){     
                stages {
                   stage("release"){  
                          when {branch 'release'}
                          steps {
                              sh "scripts/build.sh"
                          }
                    }

                   stage("stable"){
                       when{branch 'main'}
                       steps{
                           sh "scripts/build.sh"
                       }
                    }
            
                  }
               }

               stage("api") {

                    stages {
                  
                        stage("release"){  
                                when {branch 'release'}
                                  steps{
                                   sh "scripts/build.sh"  
                                }
                         }

                        stage("stable"){
                            when{branch 'main'}
                               steps{
                                sh "scripts/build.sh"     
                             } 
                        
                         }
              
                     }
               }
            }
        }

        stage("registry") {
                when { expression { BRANCH_NAME ==~ /(main|release)/ } }
                stages {

                      stage("login"){
                         
                           steps{
                                  echo "Login to the docker private registry"
                                  sh "scripts/login.sh"    
                              }
                        }
                      
                      stage("push"){

                          parallel {
                          
                                stage("mongodb"){   
                                    steps{
                                        echo "push postgres image to the docker private registry"
                                         sh "scripts/registry.sh"    
                                        }
                                    }

                                stage("api"){      
                                    steps{
                                        echo "push api image to the private registry"
                                        sh "scripts/registry.sh"    
                                    }
                                }
                          }
                      }
                 }
             }

        stage("test"){
            agent {
                docker {
                    image "node:alpine"
                }
            }

            stages {
                stage("install packages"){
                   when {
                       branch "dev"
                   }
                   steps{
                           sh "node --version"
                           sh "npm version"
                           sh "npm install"
                       }
                   
                }
                 stage("coverage") {
                    when {branch "dev"}
                    steps{
                    sh "npm run test:cov"
                     //sh "scripts/test.sh cov"
                    }

                 post{
                     always{  
                        clover(cloverReportDir: 'coverage', cloverReportFileName: 'clover.xml',
                            // optional, default is: method=70, conditional=80, statement=80
                            healthyTarget: [methodCoverage: 70, conditionalCoverage: 80, statementCoverage: 80],
                            // optional, default is none
                            unhealthyTarget: [methodCoverage: 50, conditionalCoverage: 50, statementCoverage: 50],
                            // optional, default is none
                            failingTarget: [methodCoverage: 0, conditionalCoverage: 0, statementCoverage: 0]
                        )
                    }
                     
                 }
              }

                 stage("e2e"){
                     when {branch "dev"}
                     steps{
                        echo "handle e2e test"
                        //sh "npm run test:e2e" 
                     }
                 }
            }
        }

        stage("deploy"){
            
            parallel{
                stage ('pre-prod'){
                    /*when{
                         branch 'release' 
                    }*/
                    steps{
                        sh "./infra/scripts/deploy.sh"
                        sshagent(credentials: ['devops-sshkey-private']) {
                                sh '''
                                    [ -d ~/.ssh ] || mkdir ~/.ssh && chmod 0700 ~/.ssh
                                    ssh-keyscan -t rsa,dsa prod >> ~/.ssh/known_hosts
                                    ssh donald@45.155.170.65 ...
                                '''
                                sh "ls ."
                        }   
                    }
                }

                stage('prod'){
                    when {
                        branch 'main' 
                    }
                    steps {
                        echo "publish to prod"
                        sh "scripts/deploy.sh"    
                    }
                }

            }
                              
        }
    
    }
    
}
